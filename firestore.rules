rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================================================
    // HELPER FUNCTIONS
    // =============================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if document has required fields
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Validate timestamp is recent (within last 24 hours)
    function isRecentTimestamp(ts) {
      return ts > request.time - duration.value(24, 'h');
    }

    // =============================================================================
    // USERS COLLECTION
    // =============================================================================

    match /users/{userId} {
      // Read: Own profile + public profiles
      allow read: if isAuthenticated();

      // Create: Only during signup with correct userId
      allow create: if isAuthenticated() &&
                       request.auth.uid == userId &&
                       hasRequiredFields(['email', 'createdAt']);

      // Update: Only own profile
      allow update: if isOwner(userId);

      // Delete: Only own profile
      allow delete: if isOwner(userId);

      // Subcollection: User settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }

      // Subcollection: User car details
      match /cars/{carId} {
        allow read, write: if isOwner(userId);
      }
    }

    // =============================================================================
    // DIAGNOSTICS COLLECTION (Audio/Video Analysis)
    // =============================================================================

    match /diagnostics/{diagnosticId} {
      // Read: Own diagnostics only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId, type, timestamp
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'type', 'timestamp', 'status']) &&
                       request.resource.data.type in ['audio', 'video', 'combined'];

      // Update: Own diagnostics only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own diagnostics only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // AI SCORES COLLECTION (Gemini AI Results)
    // =============================================================================

    match /aiScores/{scoreId} {
      // Read: Own scores only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include required fields
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'finalScore', 'timestamp', 'carDetails']) &&
                       request.resource.data.finalScore >= 0 &&
                       request.resource.data.finalScore <= 100;

      // Update: Own scores only (e.g., adding notes)
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own scores only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // GEMINI CHAT COLLECTION
    // =============================================================================

    match /geminiChats/{chatId} {
      // Read: Own chats only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Own chats with valid structure
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'createdAt']);

      // Update: Own chats only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own chats only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Subcollection: Chat messages
      match /messages/{messageId} {
        // Read: If user owns the parent chat
        allow read: if isAuthenticated() &&
                       get(/databases/$(database)/documents/geminiChats/$(chatId)).data.userId == request.auth.uid;

        // Create: If user owns the parent chat
        allow create: if isAuthenticated() &&
                         get(/databases/$(database)/documents/geminiChats/$(chatId)).data.userId == request.auth.uid &&
                         hasRequiredFields(['content', 'isFromUser', 'timestamp']);

        // Update: If user owns the parent chat
        allow update: if isAuthenticated() &&
                         get(/databases/$(database)/documents/geminiChats/$(chatId)).data.userId == request.auth.uid;

        // Delete: If user owns the parent chat
        allow delete: if isAuthenticated() &&
                         get(/databases/$(database)/documents/geminiChats/$(chatId)).data.userId == request.auth.uid;
      }
    }

    // =============================================================================
    // MAINTENANCE RECORDS (Carnet Intelligent)
    // =============================================================================

    match /maintenanceRecords/{recordId} {
      // Read: Own records only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include required fields
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'type', 'date', 'mileage', 'cost']);

      // Update: Own records only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own records only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // REMINDERS COLLECTION (Smart Maintenance Reminders)
    // =============================================================================

    match /reminders/{reminderId} {
      // Read: Own reminders only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: With validation
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'title', 'dueDate', 'priority']);

      // Update: Own reminders only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own reminders only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // CAR LOGS COLLECTION (Carnet Intelligent - snake_case)
    // =============================================================================

    match /car_logs/{userId} {
      // Read: Own logs only (document ID is userId)
      allow read: if isOwner(userId);

      // Create: With validation
      allow create: if isOwner(userId) &&
                       request.resource.data.userId == userId;

      // Update: Own logs only
      allow update: if isOwner(userId);

      // Delete: Own logs only
      allow delete: if isOwner(userId);

      // Subcollection: Maintenance Records
      match /maintenance_records/{recordId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // Subcollection: Reminders
      match /reminders/{reminderId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // Subcollection: Documents
      match /documents/{documentId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    // =============================================================================
    // CAR LOGS COLLECTION (Legacy - camelCase) - For backwards compatibility
    // =============================================================================

    match /carLogs/{logId} {
      // Read: Own logs only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: With validation
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'date', 'description']);

      // Update: Own logs only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own logs only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // PRICE ESTIMATES COLLECTION (Gemini Price Check)
    // =============================================================================

    match /priceEstimates/{estimateId} {
      // Read: Own estimates only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: With validation
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'carDetails', 'estimatedPrice', 'timestamp']);

      // Update: Own estimates only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own estimates only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // BOOKINGS COLLECTION (Service Provider Bookings)
    // =============================================================================

    match /bookings/{bookingId} {
      // Read: Own bookings + service provider's bookings
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid ||
                      resource.data.providerId == request.auth.uid);

      // Create: Must include required fields
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'providerId', 'date', 'service']);

      // Update: Own bookings or provider can update status
      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        resource.data.providerId == request.auth.uid);

      // Delete: Own bookings only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // MESSAGES COLLECTION (Chat between users and providers)
    // =============================================================================

    match /messages/{messageId} {
      // Read: Sender or receiver only
      allow read: if isAuthenticated() &&
                     (resource.data.senderId == request.auth.uid ||
                      resource.data.receiverId == request.auth.uid);

      // Create: Sender must be authenticated user
      allow create: if isAuthenticated() &&
                       request.resource.data.senderId == request.auth.uid &&
                       hasRequiredFields(['senderId', 'receiverId', 'content', 'timestamp']);

      // Update: Sender only
      allow update: if isAuthenticated() &&
                       resource.data.senderId == request.auth.uid;

      // Delete: Sender only
      allow delete: if isAuthenticated() &&
                       resource.data.senderId == request.auth.uid;
    }

    // =============================================================================
    // CONVERSATIONS COLLECTION
    // =============================================================================

    match /conversations/{conversationId} {
      // Read: Participants only
      allow read: if isAuthenticated() &&
                     request.auth.uid in resource.data.participants;

      // Create: Must be participant
      allow create: if isAuthenticated() &&
                       request.auth.uid in request.resource.data.participants &&
                       hasRequiredFields(['participants', 'createdAt']);

      // Update: Participants only
      allow update: if isAuthenticated() &&
                       request.auth.uid in resource.data.participants;

      // Delete: Not allowed (soft delete only)
      allow delete: if false;
    }

    // =============================================================================
    // SERVICE PROVIDERS COLLECTION
    // =============================================================================

    match /serviceProviders/{providerId} {
      // Read: Public for authenticated users
      allow read: if isAuthenticated();

      // Create: Owner must be authenticated user
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid &&
                       hasRequiredFields(['ownerId', 'name', 'services', 'location']);

      // Update: Owner only
      allow update: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;

      // Delete: Owner only
      allow delete: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;
    }

    // =============================================================================
    // SYNC QUEUE COLLECTION (Offline/Online Sync)
    // =============================================================================

    match /syncQueue/{queueId} {
      // Read: Own queue items only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: For offline operations
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Update: Own items only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own items only (after sync)
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // NOTIFICATION TOKENS (FCM)
    // =============================================================================

    match /notificationTokens/{userId} {
      // Read: Own tokens only
      allow read: if isOwner(userId);

      // Create/Update: Own tokens only
      allow create, update: if isOwner(userId);

      // Delete: Own tokens only
      allow delete: if isOwner(userId);
    }

    // =============================================================================
    // ANALYTICS COLLECTION (Optional - for tracking)
    // =============================================================================

    match /analytics/{analyticsId} {
      // Read: Not allowed (admin only via backend)
      allow read: if false;

      // Create: Authenticated users can log events
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Update/Delete: Not allowed
      allow update, delete: if false;
    }

    // =============================================================================
    // COMPREHENSIVE DIAGNOSTICS COLLECTION (Gemini AI Complete Analysis)
    // =============================================================================

    match /comprehensive_diagnostics/{diagnosticId} {
      // Read: Own comprehensive diagnostics only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId and diagnosticId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'diagnosticId', 'createdAt']) &&
                       request.resource.data.enhanced_health_score >= 0 &&
                       request.resource.data.enhanced_health_score <= 100;

      // Update: Own diagnostics only (e.g., adding notes)
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own diagnostics only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // AUDIO DIAGNOSTICS COLLECTION (TFLite Audio Analysis)
    // =============================================================================

    match /audio_diagnostics/{diagnosticId} {
      // Read: Own diagnostics only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Update: Own diagnostics only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own diagnostics only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // COMPREHENSIVE VIDEO DIAGNOSTICS COLLECTION (Gemini AI Video Analysis)
    // =============================================================================

    match /comprehensive_video_diagnostics/{diagnosticId} {
      // Read: Own comprehensive video diagnostics only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId and diagnosticId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'diagnosticId', 'createdAt']) &&
                       request.resource.data.enhanced_visual_score >= 0 &&
                       request.resource.data.enhanced_visual_score <= 100;

      // Update: Own diagnostics only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own diagnostics only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // VIDEO DIAGNOSTICS COLLECTION (ML Kit Video Analysis)
    // =============================================================================

    match /video_diagnostics/{diagnosticId} {
      // Read: Own diagnostics only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Update: Own diagnostics only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own diagnostics only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // SMART ANALYSIS REPORTS (Ultimate Combined Analysis)
    // =============================================================================

    match /smart_analysis_reports/{reportId} {
      // Read: Own reports only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId and overall_autobrain_score
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'createdAt']) &&
                       request.resource.data.overall_autobrain_score >= 0 &&
                       request.resource.data.overall_autobrain_score <= 100;

      // Update: Own reports only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own reports only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // =============================================================================
    // MARKET DATA COLLECTION (Public Read, Admin Write)
    // =============================================================================

    match /market_data/{vehicleId} {
      // Read: Anyone authenticated can read market data
      allow read: if isAuthenticated();

      // Create/Update: Reserved for admin or backend service
      // In production, use Firebase Functions to update this
      allow create, update: if false;

      // Delete: No one can delete
      allow delete: if false;
    }

    // =============================================================================
    // PRICE ESTIMATIONS COLLECTION (Gemini AI Price Analysis)
    // =============================================================================

    match /price_estimations/{estimationId} {
      // Read: Own estimations only
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Create: Must include userId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'brand', 'model', 'createdAt']);

      // Update: Own estimations only
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Delete: Own estimations only
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
  }
}
